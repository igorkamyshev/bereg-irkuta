language: node_js
sudo: required
services:
- docker
node_js:
- '10'
script: npm run ci
before_deploy:	
- docker pull "$DOCKER_USERNAME"/"$IMAGE_NAME" || true	
- docker build --pull --cache-from "$IMAGE_NAME" --tag "$IMAGE_NAME" .	
- docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"	
- docker tag "$IMAGE_NAME" "$DOCKER_USERNAME/${IMAGE_NAME}:latest"	
- docker push "$DOCKER_USERNAME/${IMAGE_NAME}:latest"
deploy:	
  skip_cleanup: true	
  provider: script	
  script:	
  - chmod 600 deploy_key && ssh -o StrictHostKeyChecking=no -i deploy_key $SERVER_USER@$SERVER_HOST "cd web/bereg-irkuta && docker-compose pull && docker-compose down && docker-compose up -d"	
  on:	
    branch: master